<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Water Quality Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .navbar {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .btn-logout {
            padding: 8px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-header h2 {
            color: #667eea;
            font-size: 1.5rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .thingspeak-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .btn-load {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-load:hover {
            background: #218838;
        }

        .btn-load:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #d4edda;
            color: #155724;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .chart-container {
            height: 350px;
            margin-top: 20px;
        }

        .parameter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .parameter-name {
            font-weight: 600;
            color: #333;
        }

        .parameter-value {
            color: #666;
        }

        .parameter-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-safe {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .health-risks {
            margin: 10px 0 20px 0;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
        }

        .risk-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
        }

        .risk-list {
            margin: 0;
            padding-left: 20px;
            color: #856404;
        }

        .risk-list li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .result-card {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-card.potable {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result-card.not-potable {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .result-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-box p {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .config-row {
                grid-template-columns: 1fr;
            }

            .navbar {
                flex-direction: column;
                gap: 15px;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üíß Water Quality IoT</h1>
                    <p>Sign in to monitor water quality in real-time</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn">Sign In</button>
                </form>
                <div class="auth-link">
                    Don't have an account? <a href="#" onclick="showPage('registerPage')">Register here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="page">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üíß Create Account</h1>
                    <p>Register to start monitoring water quality</p>
                </div>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Full Name</label>
                        <input type="text" id="registerName" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email Address</label>
                        <input type="email" id="registerEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" required placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label for="registerThingSpeakKey">ThingSpeak Read API Key (Optional)</label>
                        <input type="text" id="registerThingSpeakKey" placeholder="Your ThingSpeak API Key">
                    </div>
                    <div class="form-group">
                        <label for="registerChannelId">ThingSpeak Channel ID (Optional)</label>
                        <input type="text" id="registerChannelId" placeholder="Your Channel ID">
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
                <div class="auth-link">
                    Already have an account? <a href="#" onclick="showPage('loginPage')">Sign in here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
        <div class="dashboard">
            <nav class="navbar">
                <div class="navbar-brand">üíß Water Quality IoT Dashboard</div>
                <div class="navbar-user">
                    <span class="user-name" id="userName">User</span>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </nav>

            <div class="dashboard-grid">
                <!-- ThingSpeak Configuration -->
                <div class="card full-width">
                    <div class="card-header">
                        <h2>üåê IoT Data Configuration</h2>
                        <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
                            <span class="pulse"></span>
                            Real-time Connected
                        </div>
                    </div>
                    <div class="thingspeak-config">
                        <div class="config-row">
                            <div>
                                <div class="form-group">
                                    <label>ThingSpeak Read API Key</label>
                                    <input type="text" id="apiKey" placeholder="Enter your ThingSpeak Read API Key">
                                </div>
                                <div class="form-group">
                                    <label>Channel ID</label>
                                    <input type="text" id="channelId" placeholder="Enter your Channel ID">
                                </div>
                            </div>
                            <button class="btn-load" onclick="loadThingSpeakData()">
                                üì° Load IoT Data
                            </button>
                        </div>
                    </div>
                    <div id="dataLoadStatus"></div>
                </div>

                <!-- Water Parameters Input -->
                <div class="card">
                    <div class="card-header">
                        <h2>üî¨ Current Parameters</h2>
                    </div>
                    <form id="waterForm">
                        <div class="form-group">
                            <label>pH Level (Safe: 6.5 - 8.5)</label>
                            <input type="number" id="ph" step="0.01" min="0" max="14" required>
                        </div>
                        <div class="form-group">
                            <label>Hardness (mg/L) (Safe: 0 - 300)</label>
                            <input type="number" id="hardness" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Organic Carbon (ppm) (Safe: 0 - 20)</label>
                            <input type="number" id="organic_carbon" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Conductivity (ŒºS/cm) (Safe: 0 - 800)</label>
                            <input type="number" id="conductivity" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Turbidity (NTU) (Safe: 0 - 5)</label>
                            <input type="number" id="turbidity" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn">Analyze Water Quality</button>
                        <button type="button" class="btn btn-secondary" onclick="loadRandomValues()">üé≤ Load Random Values</button>
                    </form>
                </div>

                <!-- Analysis Results -->
                <div class="card">
                    <div class="card-header">
                        <h2>üìä Analysis Results</h2>
                    </div>
                    <div id="resultCard" class="result-card">
                        <div class="result-icon"></div>
                        <div id="resultText"></div>
                    </div>
                    <div id="parameterAnalysis" style="display: none;">
                        <h3 style="margin-bottom: 15px; color: #333;">Parameter Status</h3>
                        <div id="parameterList"></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3>Tests Performed</h3>
                            <p id="testCount">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Potable Samples</h3>
                            <p id="potableCount">0</p>
                        </div>
                    </div>
                </div>

                <!-- Historical Trends -->
                <div class="card full-width">
                    <div class="card-header">
                        <h2>üìà Real-time Trends</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Global state
        let currentUser = null;
        let testHistory = [];
        let testCount = 0;
        let potableCount = 0;
        let chart = null;

        const API_URL = 'http://localhost:5000/api/predict';

        // Health risks database
        const healthRisks = {
            ph: {
                veryLow: { threshold: 4, risks: ['Heavy metal poisoning', 'Dental erosion and tooth decay', 'Digestive irritation and acid reflux', 'Skin and hair problems', 'Mineral deficiencies', 'Corrosion of pipes leading to metal contamination'] },
                low: { threshold: 6.5, risks: ['Metallic taste', 'Pipe corrosion', 'Potential copper and lead contamination', 'Stomach discomfort'] },
                high: { threshold: 10, lowerBound: 8.5, risks: ['Bitter taste', 'Skin irritation and dryness', 'Eye irritation', 'Reduced disinfection effectiveness', 'Scale buildup in pipes'] },
                veryHigh: { threshold: 10, risks: ['Severe gastrointestinal issues', 'Skin burns and rashes', 'Eye damage', 'Nausea and vomiting', 'Potential tissue damage'] }
            },
            hardness: {
                high: { threshold: 300, risks: ['Kidney stone formation', 'Cardiovascular issues (disputed)', 'Dry and itchy skin', 'Scale buildup affecting appliances', 'Reduced soap effectiveness'] },
                veryHigh: { threshold: 500, risks: ['Increased risk of kidney stones', 'Digestive discomfort', 'Potential mineral buildup in body', 'Severe plumbing damage'] }
            },
            organic_carbon: {
                high: { threshold: 20, risks: ['Formation of harmful disinfection byproducts', 'Increased risk of cancer (with chlorination)', 'Bacterial growth promotion', 'Unpleasant taste and odor', 'Liver and kidney stress'] },
                veryHigh: { threshold: 30, risks: ['Significantly increased cancer risk', 'Serious gastrointestinal issues', 'Liver toxicity', 'Neurological effects', 'Immune system suppression'] }
            },
            conductivity: {
                high: { threshold: 800, risks: ['High mineral content', 'Salty or metallic taste', 'Laxative effects', 'Dehydration risk', 'Potential contamination indicator'] },
                veryHigh: { threshold: 1200, risks: ['Severe dehydration', 'Electrolyte imbalance', 'Kidney strain', 'Hypertension risk', 'Industrial contamination likely'] }
            },
            turbidity: {
                high: { threshold: 5, risks: ['Harbors harmful microorganisms', 'Reduced disinfection effectiveness', 'Gastrointestinal illnesses', 'Parasitic infections (Giardia, Cryptosporidium)', 'Cholera and dysentery risk'] },
                veryHigh: { threshold: 10, risks: ['High risk of waterborne diseases', 'Severe bacterial and viral infections', 'Parasitic diseases', 'Typhoid fever risk', 'Hepatitis A risk', 'Chemical contaminant carrier'] }
            }
        };

        // Auth functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                document.getElementById('userName').textContent = user.name;
                
                if (user.thingSpeakKey) {
                    document.getElementById('apiKey').value = user.thingSpeakKey;
                }
                if (user.channelId) {
                    document.getElementById('channelId').value = user.channelId;
                }
                
                showPage('dashboardPage');
                initChart();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const thingSpeakKey = document.getElementById('registerThingSpeakKey').value;
            const channelId = document.getElementById('registerChannelId').value;

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (users.find(u => u.email === email)) {
                alert('Email already registered!');
                return;
            }

            const newUser = { name, email, password, thingSpeakKey, channelId };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            alert('Registration successful! Please login.');
            showPage('loginPage');
        });

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            testHistory = [];
            testCount = 0;
            potableCount = 0;
            showPage('loginPage');
        }

        // Load ThingSpeak data
        async function loadThingSpeakData() {
            const apiKey = document.getElementById('apiKey').value;
            const channelId = document.getElementById('channelId').value;
            const statusDiv = document.getElementById('dataLoadStatus');

            if (!apiKey || !channelId) {
                statusDiv.innerHTML = '<div class="error-message">Please enter both API Key and Channel ID</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="loading">üì° Loading IoT data from ThingSpeak...</div>';

            try {
                const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${apiKey}&results=1`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.feeds && data.feeds.length > 0) {
                    const feed = data.feeds[0];
                    
                    // Map ThingSpeak fields to parameters
                    // Adjust field numbers based on your ThingSpeak channel configuration
                    document.getElementById('ph').value = feed.field1 || 7.0;
                    document.getElementById('hardness').value = feed.field2 || 200;
                    document.getElementById('organic_carbon').value = feed.field3 || 10;
                    document.getElementById('conductivity').value = feed.field4 || 400;
                    document.getElementById('turbidity').value = feed.field5 || 2;

                    statusDiv.innerHTML = '<div class="realtime-indicator"><span class="pulse"></span>Data loaded successfully! Click Analyze to check quality.</div>';
                    document.getElementById('realtimeIndicator').style.display = 'inline-flex';
                } else {
                    statusDiv.innerHTML = '<div class="error-message">No data found. Please check your API Key and Channel ID.</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error-message">Error loading data: ' + error.message + '</div>';
            }
        }

        // Prediction function
        async function predictPotability(data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('API request failed');
                return await response.json();
            } catch (error) {
                console.error('Error calling API:', error);
                return localPrediction(data);
            }
        }

        function localPrediction(data) {
            let score = 0;
            let criticalIssues = false;
            
            if (data.ph >= 6.5 && data.ph <= 8.5) score += 20;
            else if (data.ph >= 6.0 && data.ph <= 9.0) score += 10;
            else if (data.ph < 4 || data.ph > 10) criticalIssues = true;
            
            if (data.hardness <= 300) score += 20;
            else if (data.hardness <= 400) score += 10;
            else if (data.hardness > 500) criticalIssues = true;
            
            if (data.organic_carbon <= 20) score += 20;
            else if (data.organic_carbon <= 30) score += 10;
            else if (data.organic_carbon > 30) criticalIssues = true;
            
            if (data.conductivity <= 800) score += 20;
            else if (data.conductivity <= 1000) score += 10;
            else if (data.conductivity > 1200) criticalIssues = true;
            
            if (data.turbidity <= 5) score += 20;
            else if (data.turbidity <= 10) score += 10;
            else if (data.turbidity > 10) criticalIssues = true;
            
            const isPotable = !criticalIssues && score >= 70;
            
            return {
                prediction: isPotable ? 1 : 0,
                probability: criticalIssues ? 0 : score / 100,
                message: isPotable ? 'Water is POTABLE' : 'Water is NOT POTABLE'
            };
        }

        function getHealthRisks(param, value) {
            const risks = healthRisks[param];
            if (!risks) return null;

            let applicableRisks = [];

            if (param === 'ph') {
                if (value < risks.veryLow.threshold) applicableRisks = risks.veryLow.risks;
                else if (value < risks.low.threshold) applicableRisks = risks.low.risks;
                else if (value > risks.veryHigh.threshold) applicableRisks = risks.veryHigh.risks;
                else if (value > risks.high.lowerBound) applicableRisks = risks.high.risks;
            } else {
                if (risks.veryHigh && value > risks.veryHigh.threshold) applicableRisks = risks.veryHigh.risks;
                else if (risks.high && value > risks.high.threshold) applicableRisks = risks.high.risks;
            }

            return applicableRisks.length > 0 ? applicableRisks : null;
        }

        function displayParameterAnalysis(data) {
            const parameterList = document.getElementById('parameterList');
            parameterList.innerHTML = '';

            const params = [
                { key: 'ph', name: 'pH Level', value: data.ph },
                { key: 'hardness', name: 'Hardness', value: data.hardness },
                { key: 'organic_carbon', name: 'Organic Carbon', value: data.organic_carbon },
                { key: 'conductivity', name: 'Conductivity', value: data.conductivity },
                { key: 'turbidity', name: 'Turbidity', value: data.turbidity }
            ];

            params.forEach(param => {
                const safeRanges = {
                    ph: { min: 6.5, max: 8.5, unit: '' },
                    hardness: { min: 0, max: 300, unit: 'mg/L' },
                    organic_carbon: { min: 0, max: 20, unit: 'ppm' },
                    conductivity: { min: 0, max: 800, unit: 'ŒºS/cm' },
                    turbidity: { min: 0, max: 5, unit: 'NTU' }
                };

                const range = safeRanges[param.key];
                let status = 'safe';
                if (param.value < range.min || param.value > range.max) {
                    status = param.value >= range.min * 0.8 && param.value <= range.max * 1.2 ? 'warning' : 'danger';
                }

                const statusClass = status === 'safe' ? 'status-safe' : status === 'warning' ? 'status-warning' : 'status-danger';
                const statusText = status === 'safe' ? '‚úì Safe' : status === 'warning' ? '‚ö† Warning' : '‚úó Unsafe';

                const div = document.createElement('div');
                div.className = 'parameter-item';
                div.innerHTML = `
                    <span class="parameter-name">${param.name}</span>
                    <span class="parameter-value">${param.value.toFixed(2)} ${range.unit}</span>
                    <span class="parameter-status ${statusClass}">${statusText}</span>
                `;
                parameterList.appendChild(div);

                const risks = getHealthRisks(param.key, param.value);
                if (risks && risks.length > 0) {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'health-risks';
                    riskDiv.innerHTML = `
                        <div class="risk-title">‚ö†Ô∏è Potential Health Risks:</div>
                        <ul class="risk-list">
                            ${risks.map(risk => `<li>${risk}</li>`).join('')}
                        </ul>
                    `;
                    parameterList.appendChild(riskDiv);
                }
            });

            document.getElementById('parameterAnalysis').style.display = 'block';
        }

        function initChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'pH Level',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Turbidity (NTU)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Hardness (mg/L)',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Real-time Water Quality Monitoring'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!chart) return;

            const labels = testHistory.map((_, i) => `Test ${i + 1}`);
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = testHistory.map(t => t.ph);
            chart.data.datasets[1].data = testHistory.map(t => t.turbidity);
            chart.data.datasets[2].data = testHistory.map(t => t.hardness / 10); // Scale for visibility
            chart.update();
        }

        // Form submission
        document.getElementById('waterForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                ph: parseFloat(document.getElementById('ph').value),
                hardness: parseFloat(document.getElementById('hardness').value),
                organic_carbon: parseFloat(document.getElementById('organic_carbon').value),
                conductivity: parseFloat(document.getElementById('conductivity').value),
                turbidity: parseFloat(document.getElementById('turbidity').value)
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Analyzing...';
            submitBtn.disabled = true;

            const result = await predictPotability(data);
            const resultCard = document.getElementById('resultCard');
            const resultText = document.getElementById('resultText');

            testCount++;
            if (result.prediction === 1 || result.potable) potableCount++;

            testHistory.push(data);
            if (testHistory.length > 10) testHistory.shift();

            resultCard.style.display = 'block';
            if (result.prediction === 1 || result.potable) {
                resultCard.className = 'result-card potable';
                resultCard.querySelector('.result-icon').textContent = '‚úÖ';
                resultText.innerHTML = result.message + (result.probability ? `<br><small>Confidence: ${(result.probability * 100).toFixed(1)}%</small>` : '');
            } else {
                resultCard.className = 'result-card not-potable';
                resultCard.querySelector('.result-icon').textContent = '‚ùå';
                resultText.innerHTML = result.message + (result.probability ? `<br><small>Confidence: ${(result.probability * 100).toFixed(1)}%</small>` : '');
            }

            displayParameterAnalysis(data);
            document.getElementById('testCount').textContent = testCount;
            document.getElementById('potableCount').textContent = potableCount;
            updateChart();

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

            resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

        // Check if user is already logged in
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('userName').textContent = currentUser.name;
                
                if (currentUser.thingSpeakKey) {
                    document.getElementById('apiKey').value = currentUser.thingSpeakKey;
                }
                if (currentUser.channelId) {
                    document.getElementById('channelId').value = currentUser.channelId;
                }
                
                showPage('dashboardPage');
                initChart();
            }
        });

        // Load random values function
        function loadRandomValues() {
            // Generate realistic random values (mix of safe and unsafe values)
            const randomData = {
                ph: (Math.random() * (9 - 5.5) + 5.5).toFixed(2),
                hardness: (Math.random() * (500 - 50) + 50).toFixed(2),
                organic_carbon: (Math.random() * (30 - 2) + 2).toFixed(2),
                conductivity: (Math.random() * (1200 - 100) + 100).toFixed(2),
                turbidity: (Math.random() * (12 - 0.5) + 0.5).toFixed(2)
            };

            document.getElementById('ph').value = randomData.ph;
            document.getElementById('hardness').value = randomData.hardness;
            document.getElementById('organic_carbon').value = randomData.organic_carbon;
            document.getElementById('conductivity').value = randomData.conductivity;
            document.getElementById('turbidity').value = randomData.turbidity;
        }
    </script>
</body>
</html>